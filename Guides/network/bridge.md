# 使用网桥网络

在网络方面，桥接网络是在网段之间转发流量的链路层设备。桥接器可以是在主机内核中运行的硬件设备或软件设备。

就`Docker`而言，网桥网络使用软件网桥，该软件网桥允许连接到同一网桥网络的容器进行通信，同时与未连接到该网桥网络的容器隔离。 `Docker`网桥驱动程序会自动在主机中安装规则，以使不同网桥网络上的容器无法直接相互通信。

桥接网络适用于在同一`Docker`守护程序主机上运行的容器。为了在不同`Docker`守护程序主机上运行的容器之间进行通信，您可以在`OS`级别管理路由，也可以使用覆盖网络。

启动`Docker`时，会自动创建一个[默认的网桥网络](https://docs.docker.com/network/bridge/#use-the-default-bridge-network)（也称为`bridge`），除非另有说明，否则新启动的容器将连接到该网络。您还可以创建用户定义的自定义网桥网络。用户定义的网桥网络优于默认网桥网络。

## 用户定义网桥和默认网桥间的区别

- 用户定义的网桥可在容器之间提供自动`DNS`解析。

默认网桥网络上的容器只能通过IP地址相互访问，除非您使用[`--link`选项](https://docs.docker.com/network/links/)（这被认为是旧的）。在用户定义的网桥网络上，容器可以通过名称或别名相互解析。

想象一个具有`Web`前端和数据库后端的应用程序。如果将容器分别称为`Web`和`db`，则无论应用程序堆栈在哪个`Docker`主机上运行，`​​Web`容器都可以连接到`db`处的`db`容器。

如果在默认网桥网络上运行相同的应用程序堆栈，则需要在容器之间手动创建链接（使用旧版`--link`标志）。这些链接需要在两个方向上创建，因此您可以看到两个以上需要通信的容器变得很复杂。另外，您可以操纵容器中的`/etc/hosts`文件，但这会造成难以调试的问题。

- 用户定义的桥可提供更好的隔离。

所有未指定`--network`的容器都将附加到默认桥网络。这可能是一种风险，因为不相关的堆栈/服务/容器随后能够进行通信。

使用用户定义的网络可提供作用域网络，其中只有连接到该网络的容器才能通信。

- 容器可以即时从用户定义的网络连接和分离。

在容器的生命周期内，您可以即时将其与用户定义的网络连接或断开连接。要从默认网桥网络中删除容器，您需要停止容器并使用其他网络选项重新创建它。

- 每个用户定义的网络都会创建一个可配置的网桥。

如果您的容器使用默认的桥接网络，则可以对其进行配置，但是所有容器都使用相同的设置，例如`MTU`和`iptables`规则。另外，配置默认桥接网络发生在`Docker`本身之外，并且需要重新启动`Docker`。

使用`docker network create`创建和配置用户定义的桥网络。如果不同的应用程序组具有不同的网络要求，则可以在创建时分别配置每个用户定义的网桥。

- 默认网桥网络上的链接容器共享环境变量。

最初，在两个容器之间共享环境变量的唯一方法是使用`--link`标志链接它们。用户定义的网络无法进行这种类型的变量共享。但是，存在共享环境变量的高级方法。一些想法：

	- 多个容器可以使用`Docker`卷挂载包含共享信息的文件或目录。

	- 可以使用`docker-compose`一起启动多个容器，并且`compose`文件可以定义共享变量。

	- 您可以使用群集服务代替独立容器，并利用共享机密和配置。

连接到同一用户定义网桥网络的容器可以有效地将所有端口彼此公开。为了使容器或不同网络上的非`Docker`主机可以访问该端口，必须使用`-p`或`--publish`标志来发布该端口。

## 管理一个用户定义的网桥

使用`docker network create`命令创建用户定义的网桥网络。

```shell
$ docker network create my-net
```
您可以指定子网，`IP`地址范围，网关和其他选项。 有关详细信息，请参阅[`docker network create`参考](https://docs.docker.com/engine/reference/commandline/network_create/#specify-advanced-options)或`docker network create --help`的输出。

使用`docker network rm`命令删除用户定义的网桥网络。 如果容器当前已连接到网络，请先[断开它们的连接](https://docs.docker.com/network/bridge/#disconnect-a-container-from-a-user-defined-bridge)。

```shell
$ docker network rm my-net
```
> 到底发生了什么事？
> 当您创建或删除用户定义的网桥或将容器与用户定义的网桥连接或断开连接时，`Docker`会使用特定于操作系统的工具来管理基础网络基础架构（例如，在网络上添加或删除网桥设备或配置`iptables`规则） `Linux`）。 这些细节应视为实施细节。 让`Docker`为您管理用户定义的网络。

## 容器连接到用户定义的网桥

创建新容器时，可以指定一个或多个`--network`标志。 此示例将`Nginx`容器连接到`my-net`网络。 它还将容器中的端口`80`发布到`Docker`主机上的端口`8080`，以便外部客户端可以访问该端口。 连接到`my-net`网络的任何其他容器都可以访问`my-nginx`容器上的所有端口，反之亦然。

```shell
$ docker create --name my-nginx \
  --network my-net \
  --publish 8080:80 \
  nginx:latest
```
要将运行中的容器连接到现有的用户定义的桥，请使用`docker network connect`命令。 以下命令将一个已经在运行的`my-nginx`容器连接到一个已经存在的`my-net`网络：
```shell
$ docker network connect my-net my-nginx
```

## 断开容器与用户定义网桥的连接

要将运行中的容器与用户定义的桥断开连接，请使用`docker network`断开命令。 以下命令将`my-nginx`容器与`my-net`网络断开连接。

```shell
$ docker network disconnect my-net my-nginx
```
## 使用IPv6

如果需要`Docker`容器的`IPv6`支持，则需要在创建任何`IPv6`网络或分配容器`IPv6`地址之前，在`Docker`守护程序上启用该选项并重新加载其[配置](https://docs.docker.com/config/daemon/ipv6/)。

创建网络时，可以指定`--ipv6`标志以启用`IPv6`。 您无法在默认网桥网络上有选择地禁用`IPv6`支持。

## 启用从Docker容器到外界的转发
默认情况下，来自连接到默认网桥网络的容器的流量不会转发到外界。 要启用转发，您需要更改两个设置。 这些不是`Docker`命令，它们会影响`Docker`主机的内核。

1. 配置`Linux`内核以允许`IP`转发。
```shell
$ sysctl net.ipv4.conf.all.forwarding=1
```

2. 将`iptables FORWARD`策略的策略从`DROP`更改为`ACCEPT`。
```shell
sudo iptables -P FORWARD ACCEPT
```

这些设置不会在重新启动后持续存在，因此您可能需要将它们添加到启动脚本中。

## 使用默认网桥

默认桥接网络被认为是`Docker`的遗留细节，不建议用于生产环境。 对其进行配置是手动操作，存在技术缺陷。

### 将容器连接到默认网桥网络
如果您未使用`--network`标志指定网络，而是指定了网络驱动程序，则默认情况下，您的容器将连接到默认网桥网络。 除非使用旧版`--link`标志进行链接，否则连接到默认网桥网络的容器只能通过`IP`地址进行通信。

### 配置默认网桥网络
要配置默认的桥接网络，请在`daemon.json`中指定选项。 这是一个`daemon.jso`n示例，其中指定了多个选项。 仅指定您需要自定义的设置。
```json
{
  "bip": "192.168.1.5/24",
  "fixed-cidr": "192.168.1.5/25",
  "fixed-cidr-v6": "2001:db8::/64",
  "mtu": 1500,
  "default-gateway": "10.20.1.1",
  "default-gateway-v6": "2001:db8:abcd::89",
  "dns": ["10.20.1.2","10.20.1.3"]
}
```

重新启动`Docker`以使更改生效。

### 将`IPv6`与默认网桥网络一起使用
如果将`Docker`配置为支持`IPv6`（请参阅[使用`IPv6`](https://docs.docker.com/network/bridge/#use-ipv6)），则默认网桥网络也将自动配置为`IPv6`。 与用户定义的网桥不同，您无法在默认网桥上有选择地禁用`IPv6`。