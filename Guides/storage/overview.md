# 在Docker中管理数据

默认情况下，在容器内创建的所有文件都存储在可写容器层上。这意味着：

- 当该容器不再存在时，数据将不会持久保存，并且如果另一个进程需要该数据，则可能很难从容器中取出数据。
- 容器的可写层与运行容器的主机紧密耦合。您无法轻松地将数据移动到其他地方。
- 写入容器的可写层需要存储驱动程序来管理文件系统。存储驱动程序使用`Linux`内核提供联合文件系统。与使用直接写入主机文件系统的数据卷相比，这种额外的抽象降低了性能。

`Docker`为容器提供了两个选项来将文件存储在主机中，以便即使容器停止后文件也可以持久存储：卷和绑定挂载。如果您在`Linux`上运行`Docker`，则也可以使用`tmpfs`挂载。如果您在`Windows`上运行`Docker`，则还可以使用命名管道。

继续阅读有关这两种持久数据方式的更多信息。

## 选择正确的挂载类型
无论您选择使用哪种类型的挂载，容器中的数据看起来都是相同的。它在容器的文件系统中显示为目录或单个文件。

可视化卷，绑定挂载和`tmpfs`挂载之间差异的一种简单方法是考虑数据在`Docker`主机上的位置。

![挂载区别](images/types-of-mounts.png)

- 卷存储在由`Docker`管理的主机文件系统的一部分中（在`Linux`上为`/var/lib/docker/volumes/`）。 非`Docker`进程不应修改文件系统的这一部分。 卷是在`Docker`中持久保存数据的最佳方法。

- 绑定挂载可以存储在主机系统上的任何位置。 它们甚至可能是重要的系统文件或目录。 `Docker`主机或`Docker`容器上的非`Docker`进程可以随时对其进行修改。

- `tmpfs`挂载仅存储在主机系统的内存中，并且永远不会写入主机系统的文件系统中。

### 有关挂载类型的更多详细信息
- 卷：由`Docker`创建和管理。您可以使用`docker volume create`命令显式创建卷，或者`Docker`可以在容器或服务创建期间创建卷。

创建卷时，它存储在`Docker`主机上的目录中。将卷装入容器时，此目录就是装入容器的目录。这类似于绑定挂载的工作方式，除了卷由`Docker`管理并且与主机的核心功能隔离。

给定的卷可以同时安装到多个容器中。当没有正在运行的容器使用卷时，该卷仍可用于`Docker`，并且不会自动删除。您可以使用`docker volume prune`删除未使用的卷。

挂载卷时，它可能是命名的或匿名的。匿名卷首次安装到容器中时，不会为其指定显式名称，因此`Docker`为它们提供一个随机名称，该名称在给定`Docker`主机中保证是唯一的。除了名称之外，命名卷和匿名卷的行为也相同。

卷还支持使用卷驱动程序，这使您可以将数据存储在远程主机或云提供商上。

- 绑定挂载：自`Docker`早期以来可用。与卷相比，绑定安装的功能有限。使用绑定安装时，会将主机上的文件或目录安装到容器中。该文件或目录由主机上的完整路径引用。该文件或目录不需要在`Docker`主机上已经存在。如果尚不存在，则按需创建。绑定挂载性能非常好，但是它们依赖于具有特定目录结构的主机文件系统。如果要开发新的`Docker`应用程序，请考虑使用命名卷。您不能使用`Docker CLI`命令直接管理绑定安装。

> 绑定安装允许访问敏感文件
> 使用绑定安装的好与坏的一个副作用是，您可以通过容器中运行的进程来更改主机文件系统，包括创建，修改或删除重要的系统文件或目录。这是一项强大的功能，可能会带来安全隐患，包括影响主机系统上的非`Docker`进程。

- `tmpfs`装载：`tmpfs`装载不会持久化在磁盘上，无论是在`Docker`主机上还是在容器内。容器在其生存期内可以使用它来存储非持久状态或敏感信息。例如，在内部，群服务使用`tmpfs`挂载将机密挂载到服务的容器中。

- 命名管道：`npipe`安装可用于`Docker`主机与容器之间的通信。常见用例是在容器内运行第三方工具，并使用命名管道连接到`Docker Engine API`。

绑定安装和卷都可以使用`-v`或`--volume`标志安装到容器中，但是两者的语法略有不同。对于`tmpfs`挂载，可以使用`--tmpfs`标志。但是，在`Docker 17.06`及更高版本中，建议将`--mount`标志用于容器和服务，用于绑定安装，卷或`tmpfs`安装，因为语法更清晰。

## 使用卷的case
卷是将数据持久保存在`Docker`容器和服务中的首选方法。卷的一些用例包括：

- 在多个运行中的容器之间共享数据。如果您未明确创建它，则将在第一次将其安装到容器中时创建该卷。当该容器停止或卸下时，该卷仍然存在。多个容器可以同时装载相同的卷（读写或只读）。仅在显式删除卷时才将它们删除。

- 不保证`Docker`主机具有给定的目录或文件结构时。卷可帮助您将`Docker`主机的配置与容器运行时解耦。

- 当您要将容器的数据存储在远程主机或云提供商上时，而不是在本地。

- 当您需要将数据从一个`Docker`主机备份，还原或迁移到另一个`Docker`主机时，卷是一个更好的选择。您可以停止使用该卷的容器，然后备份该卷的目录（例如`/var/lib/docker/volumes/<volume-name>`）。

## 使用绑定挂载的case
通常，应尽可能使用卷。绑定安装适用于以下类型的用例：

- 将配置文件从主机共享到容器。默认情况下，这是`Docker`通过将`/etc/resolv.conf`从主机安装到每个容器中来为容器提供`DNS`解析的方式。

- 在`Docker`主机上的开发环境和容器之间共享源代码或构建工件。例如，您可以将`Maven` `target/`目录安装到容器中，并且每次在`Docker`主机上构建`Maven`项目时，该容器都可以访问重建的工件。

如果您以这种方式使用`Docker`进行开发，那么您的生产`Dockerfile`会将生产就绪的工件直接复制到映像中，而不是依赖于绑定安装。

- 当确保`Docker`主机的文件或目录结构与容器所需的绑定安装一致时。

## tmpfs挂载的好用例
`tmpfs`挂载最适用于您不希望数据在主机或容器内持久存在的情况。当您的应用程序需要写入大量非持久状态数据时，这可能是出于安全原因或为了保护容器的性能。

## 使用绑定挂载或卷的提示
如果使用绑定挂载或卷，请牢记以下几点：

- 如果将空卷装入存在文件或目录的容器中的目录中，则这些文件或目录将传播（复制）到该卷中。 同样，如果启动一个容器并指定一个尚不存在的卷，则会为您创建一个空卷。 这是预填充另一个容器所需数据的好方法。

- 如果将绑定挂载或非空卷安装到存在某些文件或目录的容器中的目录中，则这些文件或目录会被安装遮盖，就像您将文件保存到`Linux`主机上的`/mnt`中一样，然后 将`USB`驱动器安装到`/mnt`中。 在卸载`USB`驱动器之前，`/mnt`的内容将被`USB`驱动器的内容遮盖。 不会删除或更改被遮盖的文件，但是在装入绑定安装或卷时将无法访问这些文件。