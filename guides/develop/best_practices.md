# `Docker`开发最佳实践

事实证明，以下开发模式对使用`Docker`构建应用程序的人们很有帮助。如果您发现了我们应该添加的内容，请告诉我们。

## 如何缩小镜像
小镜像在启动容器或服务时更快地通过网络传输，更快地加载到内存中。有一些经验法则可以使镜像尺寸较小：

- 从适当的基础镜像开始。例如，如果您需要`JDK`，请考虑将镜像基于正式的`openjdk`镜像，而不是从通用的`ubuntu`镜像开始并将`openjdk`作为`Dockerfile`的一部分进行安装。

- 使用多阶段构建。例如，您可以使用`Maven`镜像来构建`Java`应用程序，然后重置为`tomcat`镜像并将`Java`构建复制到正确的位置以部署您的应用程序，所有这些操作都在同一`Dockerfile`中。这意味着您的最终镜像不包括构建所引入的所有库和依赖项，而仅包括运行它们所需的工件和环境。

	- 如果您需要使用不包含多阶段构建的`Docker`版本，请尝试通过最小化`Dockerfile`中单独的`RUN`命令的数量来减少镜像中的层数。为此，您可以将多个命令合并到一条`RUN`行中，并使用`Shell`的机制将它们组合在一起。考虑以下两个片段。第一层在镜像中创建两层，而第二层仅创建一层。
	```shell
	RUN apt-get -y update
	RUN apt-get install -y python
	RUN apt-get -y update && apt-get install -y python
	```
	- 如果您有多个具有很多共同点的镜像，请考虑使用共享的组件创建自己的基本镜像，并在此基础上创建唯一的镜像。 `Docker`只需要加载一次公共层，然后将它们缓存。 这意味着您的派生镜像将更有效地使用`Docker`主机上的内存，并更快地加载。

	- 为了使生产镜像保持精简但允许进行调试，请考虑将生产镜像用作调试镜像的基础镜像。 可以在生产镜像的顶部添加其他测试或调试工具。

	- 在构建镜像时，请始终使用有用的标签对其进行标记，这些标签可将版本信息，预期目标（例如，产品或测试），稳定性或其他在不同环境中部署应用程序时有用的信息进行整理。 不要依赖自动创建的最新标签。

## 在何处以及如何保留应用程序数据
- 避免使用存储驱动程序将应用程序数据存储在容器的可写层中。这会增加容器的大小，并且从`I/O`角度来看，效率不如使用卷或绑定挂载。
- 使用卷存储数据。
- 一种适合使用绑定挂载的情况是在开发过程中，当您可能想挂载源目录或刚刚构建在容器中的二进制文件时。对于生产环境，请改用卷，将其挂载到与开发期间挂载绑定相同的位置。
- 对于生产环境，请使用机密存储服务使用的敏感应用程序数据，并对非敏感数据（例如配置文件）使用`configs`。如果当前使用独立容器，请考虑迁移以使用单一副本服务，以便可以利用这些仅服务功能。

## 使用`CI/CD`进行测试和部署
- 当您检查对源代码控制的更改或创建拉取请求时，请使用`Docker Hub`或其他`CI/CD`管道自动构建并标记`Docker`镜像并对其进行测试。

- 通过要求您的开发，测试和安全团队在可部署到生产环境中的镜像之前对`Docker Engine-Enterprise`进行进一步的处理。这样，您可以确定在将镜像部署到生产中之前，它已经由开发，质量和安全团队进行了测试和签名。

## 开发和生产环境的差异

| 开发 | 生产 |
| --- | --- |
| 使用绑定挂载使您的容器可以访问源代码。 | 使用卷保存容器数据 |
| 使用适用于`Mac`的`Docker Desktop`或适用于`Windows`的`Docker Desktop`。 | 如果可能，请使用`Docker Engine-Enterprise`，并通过用户映射来更好地将`Docker`进程与主机进程隔离。 |
| 不用担心时间漂移。 | 始终在`Docker`主机和每个容器进程中运行`NTP`客户端，并将它们全部同步到同一`NTP`服务器。 如果使用`swarm`服务，还请确保每个`Docker`节点将其时钟同步到与容器相同的时间源。 |