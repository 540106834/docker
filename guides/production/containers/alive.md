# 在守护程序停机期间使容器保持活动状态

默认情况下，当`Docker`守护程序终止时，它将关闭正在运行的容器。从`Docker Engine 1.12`开始，您可以配置守护程序，以便在守护程序不可用时容器仍在运行。此功能称为实时还原。实时还原选项有助于减少由于守护程序崩溃，计划内的中断或升级而导致的容器停机时间。

> 注意：`Windows`容器不支持实时还原，但是它确实适用于在`Docker Desktop for Windows`上运行的`Linux`容器。

## 启用即时恢复
有两种方法可以启用实时还原设置，以在守护程序不可用时使容器保持活动状态。请仅执行以下一项。

- 将配置添加到守护程序配置文件。在`Linux上`，默认为`/etc/docker/daemon.json`。在`Mac`的`Docker`桌面或`Windows`的`Docker`桌面上，从任务栏中选择`Docker`图标，然后单击 首选项 -> 守护程序 -> 高级。

	- 使用以下JSON启用live-restore。
	```shell
	{
  	"live-restore": true
	}
	```
	- 重新启动`Docker`守护程序。在`Linux`上，可以通过重新加载`Docker`守护程序来避免重启（并避免容器出现任何停机）。如果使用 `systemd`，则使用命令`systemctl reload docker`。否则，向`dockerd`进程发送 `SIGHUP`信号。

- 如果愿意，可以`dockerd`使用该`--live-restore`标志手动启动该过程 。不建议使用此方法，因为它不会设置`systemd`启动`Docker`进程时将使用的环境或其他进程管理器。这可能会导致意外的行为。

## 在升级过程中现场恢复
实时还原支持在`Docker`守护程序升级期间保持容器运行，尽管这仅限于修补程序版本，并且不支持次要或主要守护程序升级。

如果您在升级过程中跳过发行版，则守护程序可能无法恢复其与容器的连接。如果守护程序无法恢复连接，则它无法管理正在运行的容器，您必须手动停止它们。

## 在重新启动时恢复活跃状态
仅当守护程序选项（例如网桥`IP`地址和图形驱动程序）未更改时，实时还原选项才可用于还原容器。如果这些守护程序级别的配置选项中的任何一个已更改，则实时还原可能无法正常工作，您可能需要手动停止容器。

## 实时还原对正在运行的容器的影响
如果守护程序长时间关闭，正在运行的容器可能会填满该守护程序通常读取的`FIFO`日志。完整的日志会阻止容器记录更多数据。默认缓冲区大小为64K。如果缓冲区已满，则必须重新启动`Docker`守护程序以刷新它们。

在`Linux`上，您可以通过更改来修改内核的缓冲区大小 `/proc/sys/fs/pipe-max-size`。您无法在`Mac`的`Docker`桌面或`Windows`的`Docker`桌面上修改缓冲区大小。

## 实时还原和`Swarm`模式
实时还原选项仅适用于独立容器，不适用于`Swarm`服务。`Swarm`服务由`Swarm`管理器管理。如果`Swarm`管理器不可用，则`Swarm`服务将继续在工作程序节点上运行，但是只有在有足够的`Swarm`管理器可用于维持仲裁之前，才能对`Swarm`服务进行管理。