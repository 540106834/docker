# Docker简介

`Docker`是一个用于开发，交付和运行应用程序的开放平台。 `Docker`使您能够将应用程序与基础架构分开，从而可以快速交付软件。 借助`Docker`，您可以以与管理应用程序相同的方式来管理基础架构。 通过利用`Docker`的快速交付，测试和部署代码的方法，您可以大大减少编写代码和在生产环境中运行代码之间的延迟。

## Docker平台

`Docker`提供了在松散隔离的环境（称为容器）中打包和运行应用程序的功能。隔离和安全性使您可以在给定主机上同时运行多个容器。容器轻巧，因为它们不需要管理程序的额外负担，而是直接在主机的内核中运行。这意味着与使用虚拟机相比，您可以在给定的硬件组合上运行更多的容器。您甚至可以在实际上是虚拟机的主机中运行`Docker`容器！

`Docker`提供了工具和平台来管理容器的生命周期：

- 使用容器开发应用程序及其支持组件。
- 容器成为分发和测试应用程序的单元。
- 准备就绪后，可以将应用程序作为容器或协调服务部署到生产环境中。无论您的生产环境是本地数据中心，云提供商还是两者的混合，其工作原理都相同。

## Docker引擎

`Docker`引擎是具有以下主要组件的客户端-服务器应用程序：

- 服务器是一种长期运行的程序，称为守护程序进程（`dockerd`命令）。
- `REST API`，它指定程序可以用来与守护程序进行通信并指示其操作的接口。
- 命令行界面（`CLI`）客户端（`docker`命令）

![docker_engine](images/engine-components-flow.png)

`CLI`使用`Docker REST API`通过脚本或直接`CLI`命令控制或与`Docker`守护程序交互。 许多其他`Docker`应用程序都使用基础`API`和`CLI`。

> 守护程序将创建和管理`Docker`对象，例如镜像，容器，网络和卷。

注意：`Docker`已获得开源`Apache 2.0`许可证的许可。

有关更多详细信息，请参阅下面的[`Docker`体系结构](https://docs.docker.com/engine/docker-overview/#docker-architecture)。

## 能用Docker做什么

### 快速，一致地交付您的应用程序

`Docker`通过允许开发人员使用提供您的应用程序和服务的本地容器在标准化环境中工作，从而简化了开发生命周期。容器非常适合持续集成和持续交付（`CI/CD`）工作流程。

请考虑以下示例方案：

- 您的开发人员在本地编写代码，并使用`Docker`容器与同事共享他们的工作。
- 他们使用`Docker`将其应用程序推送到测试环境中，并执行自动和手动测试。
- 当开发人员发现错误时，他们可以在开发环境中对其进行修复，然后将其重新部署到测试环境中以进行测试和验证。
- 测试完成后，将修补程序推送给生产环境就像将更新的镜像推送到生产环境一样简单。

### 响应式部署和扩展

`Docker`基于容器的平台允许高度可移植的工作负载。 `Docker`容器可以在开发人员的本地笔记本电脑上，数据中心中的物理或虚拟机上，云提供商上或混合环境中运行。

`Docker`的可移植性和轻量级的特性还使您可以轻松地动态管理工作负载，并根据业务需求指示实时扩展或拆除应用程序和服务。

### 在同一硬件上运行更多工作负载

`Docker`轻巧快速。它为基于虚拟机管理程序的虚拟机提供了可行且经济高效的替代方案，因此您可以利用更多的计算能力来实现业务目标。 `Docker`非常适合高密度环境和中小型部署，而您需要用更少的资源做更多的事情。

## Docker架构

`Docker`使用客户端-服务器架构。 `Docker`客户端与`Docker`守护进程进行对话，该守护进程完成了构建，运行和分发`Docker`容器的繁重工作。 `Docker`客户端和守护程序可以在同一系统上运行，或者您可以将`Docker`客户端连接到远程`Docker`守护程序。 `Docker`客户端和守护程序在`UNIX`套接字或网络接口上使用`REST API`进行通信。

![architecture](images/architecture.svg)

### `Docker`守护程序
`Docker`守护程序（`dockerd`）侦听`Docker API`请求并管理`Docker`对象，例如镜像，容器，网络和卷。守护程序还可以与其他守护程序通信以管理`Docker`服务。

### `Docker`客户端
`Docker`客户端（`docker`）是许多`Docker`用户与`Docker`交互的主要方式。当您使用诸如`docker run`之类的命令时，客户端会将这些命令发送至`dockerd`，然后执行它们。 `docker`命令使用`Docker API`。 `Docker`客户端可以与多个守护程序通信。

### `Docker`仓库
`Docker`仓库存储`Docker`镜像。 `Docker Hub`是任何人都可以使用的公共仓库，并且`Docker`配置为默认在`Docker Hub`上查找镜像。您甚至可以运行自己的私人仓库。如果使用`Docker`数据中心（`DDC`），则其中包括`Docker`可信任仓库（`DTR`）。

使用`docker pull`或`docker run`命令时，所需的镜像将从配置的仓库中提取。使用`docker push`命令时，会将镜像推送到配置的仓库。

### `Docker`对象
使用`Docker`时，您正在创建和使用镜像，容器，网络，卷，插件和其他对象。本节是其中一些对象的简要概述。

#### 镜像
镜像是一个只读模板，其中包含创建`Docker`容器的说明。通常，一个镜像基于另一个镜像，并进行一些其他自定义。例如，您可以构建基于`ubuntu`镜像的镜像，但安装`Apache Web`服务器和您的应用程序，以及运行应用程序所需的配置详细信息。

您可以创建自己的镜像，也可以仅使用其他人创建并在仓库中发布的镜像。要构建自己的镜像，您可以使用简单的语法创建一个`Dockerfile`，以定义创建镜像并运行它所需的步骤。 `Dockerfile`中的每条指令都会在镜像中创建一个层。更改`Dockerfile`并重建镜像时，仅重建那些已更改的层。与其他虚拟化技术相比，这是使镜像如此轻巧，小型和快速的部分原因。

#### 容器
容器是镜像的可运行实例。您可以使用`Docker API`或`CLI`创建，启动，停止，移动或删除容器。您可以将容器连接到一个或多个网络，将存储附加到该网络，甚至根据其当前状态创建新镜像。

默认情况下，容器与其他容器及其主机之间的隔离程度相对较高。您可以控制容器的网络，存储或其他底层子系统与其他容器或主机之间的隔离程度。

容器由其镜像以及在创建或启动时为其提供的任何配置选项定义。删除容器后，未存储在持久性存储中的状态更改将消失。

#### `docker run`命令例子

以下命令运行`ubuntu`容器，以交互方式附加到本地命令行会话，然后运行`/bin/bash`。
```shell
$ docker run -i -t ubuntu /bin/bash
```
当您运行此命令时，会发生以下情况（假设您使用的是默认配置）：

1. 如果本地没有`ubuntu`镜像，则`Docker`会将其从配置的仓库中拉出，就像您已手动运行`docker pull ubuntu`一样。

2. `Docker`创建了一个新容器，就像您已经手动运行`docker container create`命令一样。

3. `Docker`将一个读写文件系统分配给容器，作为其最后一层。这允许运行中的容器在其本地文件系统中创建或修改文件和目录。

4. `Docker`创建了一个网络接口以将容器连接到默认网络，因为您未指定任何网络选项。这包括为容器分配IP地址。默认情况下，容器可以使用主机的网络连接连接到外部网络。

5. `Docker`启动容器并执行`/bin/bash`。由于容器是交互式运行的，并且已附加到您的终端（由于`-i`和`-t`标志），因此您可以在输出记录到终端时使用键盘提供输入。

6. 当您键入`exit`终止`/bin/bash`命令时，该容器将停止但不会被删除。您可以重新启动或删除它。

#### 服务
服务使您可以在多个`Docker`守护程序之间扩展容器，这些守护程序都可以与多个管理者和工作人员一起工作。 一个集群的每个成员都是一个`Docker`守护程序，并且所有守护程序都使用`Docker API`进行通信。 服务允许您定义所需的状态，例如在任何给定时间必须可用的服务副本数。 默认情况下，该服务在所有工作节点之间实现负载平衡。 对于消费者而言，`Docker`服务似乎是一个单独的应用程序。 `Docker Engine`在`Docker 1.12`及更高版本中支持集群模式。

### 底层技术
`Docker`用`Go`编写，并利用`Linux`内核的多个功能来交付其功能。

#### 命名空间
`Docker`使用一种称为命名空间的技术来提供称为容器的隔离工作区。运行容器时，`Docker`会为该容器创建一组命名空间。

这些命名空间提供了一层隔离。容器的每个方面都在单独的命名空间中运行，并且其访问仅限于该命名空间。

`Docker Engine`在`Linux`上使用以下命名空间：

- `pid`名称空间：进程隔离（`PID`：进程`ID`）。
- `net`名称空间：管理网络接口（`NET`：网络）。
- `ipc`名称空间：管理对`IPC`资源的访问（`IPC`：进程间通信）。
- `mnt`名称空间：管理文件系统安装点（`MNT`：安装）。
- `uts`名称空间：隔离内核和版本标识符。 （`UTS`：`Unix`时间共享系统）。

#### 控制组
`Linux`上的`Docker`引擎还依赖于另一种称为控制组（`cgroups`）的技术。 `cgroup`将应用程序限制为一组特定的资源。控制组允许`Docker Engine`将可用的硬件资源共享给容器，并有选择地实施限制和约束。例如，您可以限制特定容器可用的内存。

#### 联合文件系统
联合文件系统或`UnionFS`是通过创建镜像进行操作的文件系统，使其非常轻便且快速。 `Docker Engine`使用`UnionFS`为容器提供构建模块。 `Docker Engine`可以使用多个`UnionFS`变体，包括`AUFS`，`btrfs`，`vfs`和`DeviceMapper`。

#### 容器格式
`Docker Engine`将命名空间，控制组和`UnionFS`组合到一个称为容器格式的包装器中。默认容器格式为`libcontainer`。将来，`Docker`可以通过与`BSD Jails`或`Solaris Zones`等技术集成来支持其他容器格式。